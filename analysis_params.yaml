# TCRMP 3D Analysis Parameters
# Edit this file to configure your analysis

# Project Information
project:
  name: "TCRMP_3D_Example"
  notes: |
    Example project demonstrating the TCRMP 3D processing workflow.
    This is a template for setting up new projects.

# Directory Configuration
directories:
  video_source: "video_source"  # Directory containing MP4/MOV files
  base: "."                     # Current directory
  data: "data"                  # Will be created in project directory
  output: "output"              # Will be created in project directory
  adobe_presets: "../../presets/lightroom"   # Adobe Lightroom presets
  metashape_presets: "../../presets/premiere"  # Metashape presets
  scripts: "../../src"          # Location of processing scripts
  config: "../../src/config.py" # Location of config file
  final_outputs: "output/final" # Location for final outputs
  psx_input: "psx_input"        # Input PSX files
  reports: "reports"            # Reports directory for PDF output
  frames: "frames"              # Extracted frames directory
  psx_output: "05_outputs/psx"  # Output PSX directory for final projects
  models: "models"              # 3D model exports
  orthomosaics: "orthomosaics"  # Orthomosaic exports

# Processing Parameters
processing:
  # Frame Extraction (step0.py)
  frames_per_transect: 100  # Number of frames to extract per model
  extraction_rate: 0.5      # 1.0 = all frames, 0.5 = every other frame
  
  # Initial 3D Processing (step1.py)
  chunk_size: 400  # Maximum number of frames per chunk
  use_gpu: true    # Whether to use GPU for processing
  max_chunks_per_psx: 5     # Maximum number of chunks per PSX file for batch processing
  metashape:
    defaults:
      # Point filtering thresholds
      reconstruction_uncertainty: 50  # Maximum allowable reconstruction uncertainty value (lower is better)
      reprojection_error: 1           # Maximum allowable reprojection error in pixels (lower is better) 
      projection_accuracy: 10         # Maximum allowable projection accuracy value (lower is better)
      
      # Photo matching parameters
      keypoint_limit: 40000           # Maximum number of keypoints per image
      tiepoint_limit: 4000            # Maximum number of tie points per image pair
      downscale: 1                    # Downscale factor for photos (1=highest quality, no downscaling)
      generic_preselection: true      # Use image content for pre-selecting image pairs
      reference_preselection: true    # Use image metadata for pre-selecting image pairs  
      filter_stationary_points: false # Filter stationary points that don't contribute to the geometry
      
      # Camera optimization
      fit_k4: true                    # Fit 4th radial distortion coefficient
      adaptive_fitting: true          # Adaptively fit camera parameters based on estimated reliability
      
      # Depth map parameters
      depth_downscale: 4              # Downscale factor for depth maps (4=medium quality)
      depth_filter_mode: "NoFiltering" # Depth map filtering mode: NoFiltering, MildFiltering, ModerateFiltering, AggressiveFiltering
      
      # Model building parameters
      surface_type: "Arbitrary"        # Surface type: Arbitrary (freeform) or HeightField (flat surface)
      interpolation: "EnabledInterpolation" # Interpolation mode: DisabledInterpolation, EnabledInterpolation, Extrapolated
      face_count: "HighFaceCount"      # Target face count: LowFaceCount, MediumFaceCount, HighFaceCount, CustomFaceCount
      volumetric_masks: false          # Use volumetric masking
      vertex_colors: true              # Calculate vertex colors
      
      # Model smoothing
      smooth_strength: 3               # Smoothing strength (1-10, higher=smoother)
      fix_borders: true                # Fix model borders during smoothing
      preserve_edges: false            # Preserve sharp edges during smoothing
      
      # UV mapping
      mapping_mode: "GenericMapping"   # UV mapping mode: GenericMapping, OrthophotoMapping, AdaptiveOrthophotoMapping, SphericalMapping, CameraMapping
      texture_size: 16384              # Texture size in pixels (power of 2)
      page_count: 4                    # Number of texture pages
      
      # Texture building
      texture_type: "DiffuseMap"       # Texture type: DiffuseMap, NormalMap, OcclusionMap
      blending_mode: "MosaicBlending"  # Blending mode: AverageBlending, MosaicBlending, MaxBlending, MinBlending, DisabledBlending
      fill_holes: true                 # Fill texture holes
      ghosting_filter: true            # Filter ghosting artifacts
      enable_gpu: false                # Use GPU for texture generation
      relaxed_precision: true          # Use relaxed precision for texture generation
  
  # Chunk Management (step2.py)
  chunk_management:
    psx_startdir: "psx_input"         # Starting directory for PSX files
    psx_finaldir: "05_outputs/psx"    # Final directory for PSX files
    chunk_quality:
      min_cameras: 10                 # Minimum number of aligned cameras for a quality chunk
      min_alignment_percentage: 90    # Minimum percentage of aligned cameras for a quality chunk
  
  # Exports and Scale Bars (step3.py)
  model_processing:
    has_coded_scales: false           # Whether the model has coded scale markers
    scale_bars:                       # Scale bar definitions if using coded markers
      - start_marker: "target 1000"   # First marker label
        end_marker: "target 1010"     # Second marker label
        distance: 0.75               # Distance between markers in meters
      - start_marker: "target 1020"
        end_marker: "target 1030"
        distance: 0.75
    model_cleanup:
      min_faces: 100                 # Minimum faces for a component to be kept
      min_vertices: 50               # Minimum vertices for a component to be kept
      remove_small_components: true  # Whether to remove small disconnected components
    orthomosaic:
      resolution: 0.001              # Resolution in meters/pixel (1mm)
      blending_mode: "MosaicBlending" # Blending mode for orthomosaic
      fill_holes: true               # Fill holes in orthomosaic
      save_alpha: true               # Save alpha channel
      save_world: true               # Save world file
      save_xyz: true                 # Save XYZ coordinate file
      tile_width: 2048               # Tile width for tiled export
      tile_height: 2048              # Tile height for tiled export
      compression: "LZW"             # Compression type: None, LZW, JPEG, Packbits
    model_export:
      format: "OBJ"                  # Model format: OBJ, 3DS, FBX, etc.
      texture_format: "JPEG"         # Texture format: JPEG, PNG, TIFF
      texture_size: 4096             # Texture size for export
      save_texture: true             # Save textures with model
      save_uv: true                  # Save UV coordinates
      save_normals: true             # Save normal vectors
      save_colors: true              # Save vertex colors
  
  # Final Exports and Web Publishing (step4.py)
  final_exports:
    decimate_vertices: 3000000        # Number of vertices for decimated model (for web)
    sketchfab:
      token: "152b6186db06477482e2b42b327541da"  # Sketchfab API token
      title_template: "Model: {chunk_label}"     # Template for model title
      description: "generated using Metashape."   # Model description
      tags: "3D, model, Metashape, coralreef"     # Tags for model
      is_draft: true                  # Whether to publish as draft
      is_private: false               # Whether model is private
    final_orthomosaic:
      resolution: 0.0005              # Final orthomosaic resolution (0.5mm)
      save_alpha: true                # Save alpha channel
      save_world: true                # Save world file
      save_xyz: true                  # Save XYZ coordinate file
    final_model:
      texture_format: "JPEG"          # Texture format
      texture_size: 4096              # Texture size
      save_texture: true              # Save textures
      save_uv: true                   # Save UV coordinates
      save_normals: true              # Save normals
      save_colors: true               # Save vertex colors
    point_cloud:
      format: "LAS"                   # Point cloud format
      save_colors: true               # Save point colors
      save_normals: true              # Save point normals
  
  # File Naming
  psx_filename: "TCRMP{date}_3D_{site}"  # Template for final PSX files in output/psx/ 